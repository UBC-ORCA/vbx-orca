-include config.mk
BUS_TYPES := $(filter-out csmith%,$(patsubst system_%.qsys,%,$(wildcard system_*.qsys)))

ifndef BUS_TYPE
$(info INFO: BUS_TYPE not defined, defaulting to avalon )
BUS_TYPE := avalon
endif
ifeq ($(filter $(BUS_TYPE), $(BUS_TYPES)),)
$(error BUS_TYPE $(BUS_TYPE) is not in the list of bus types ($(BUS_TYPES)))
endif

.PHONY: all
all:

SYSTEM          := system_$(BUS_TYPE)
SYSTEMS         := $(BUS_TYPES:%=system_%)
QSYS_FILE       := $(SYSTEM).qsys
QSYS_FILES      := $(SYSTEMS:%=%.qsys)
SIM_WAVES_FILE  := sim_waves_system_$(BUS_TYPE).tcl
SIM_WAVES_FILES := $(BUS_TYPES:%=sim_waves_system_%.tcl)
SIM_FILE        := simulate_$(BUS_TYPE).tcl
SIM_FILES       := $(BUS_TYPES:%=simulate_%.tcl)
MSIM_FILE       := $(SYSTEM)/simulation/mentor/msim_setup.tcl
MSIM_FILES      := $(SYSTEMS:%=%/simulation/mentor/msim_setup.tcl)
TEST_HEX        := $(SYSTEM)/simulation/mentor/test.hex
TEST_HEXES      := $(SYSTEMS:%=%/simulation/mentor/test.hex)
TEST_LOG        := test_$(BUS_TYPE).log
TEST_LOGS       := $(BUS_TYPES:%=test_%.log)

ORCA_ROOT       ?= ../..
ORCA_HW_TCL     := $(ORCA_ROOT)/ip/orca/orca_hw.tcl
ORCA_HDL        := $(wildcard $(ORCA_ROOT)/ip/orca/hdl/*.vhd)

.PHONY: gui-qsys
gui-qsys: $(QSYS_FILE)
	qsys-edit $(QSYS_FILE) --search-path="./,$(ORCA_ROOT)/ip/,$$" &

%/simulation/mentor/msim_setup.tcl: %.qsys $(ORCA_HW_TCL)
	qsys-generate --simulation=vhdl $<
	(cd $(*)/simulation/submodules/vblox_orca; for i in *.vhd; do if [ -f ../../../../ip/orca/hdl/$$i ] ; then ln -sf ../../../../ip/orca/hdl/$$i $$i; fi; done; )
	if [ -e $(*)/simulation/submodules/vblox_lve ]; then (cd $(*)/simulation/submodules/vblox_lve; for i in *.vhd; do if [ -f ../../../../ip/orca/lve/hdl/$$i ] ; then ln -sf ../../../../ip/lve/hdl/$$i $$i; fi; done; ); fi

test:
	mkdir -p $@

ORCA_TEST_DIRS  := $(shell find $(ORCA_ROOT)/software/orca-tests -mindepth 2 -name 'Makefile' | xargs -n 1 dirname)
ORCA_TESTS      ?= $(notdir $(ORCA_TEST_DIRS))
ORCA_TEST_ELFS  := $(patsubst %,test/%.elf,$(ORCA_TESTS))
ORCA_TEST_DUMPS := $(patsubst %,test/%.dump,$(ORCA_TESTS))
ORCA_TEST_QEXES := $(patsubst %,test/%.qex,$(ORCA_TESTS))
PWD_ABSPATH     := $(abspath $(shell pwd))
LD_SCRIPT       := $(PWD_ABSPATH)/link.ld

test/%.elf test/%.qex test/%.dump: | test $(ORCA_ROOT)/software/orca-tests/%
	$(MAKE) -C $(ORCA_ROOT)/software/orca-tests/$*/ $(PWD_ABSPATH)/test/$*.elf $(PWD_ABSPATH)/test/$*.qex $(PWD_ABSPATH)/test/$*.dump OUTPUT_DIR=$(PWD_ABSPATH)/test LD_SCRIPT=$(LD_SCRIPT) RISCV_OLEVEL=-O3

#This list should be autogenerated but is currently done by a separate script.
#It must be regenerated when generate_hex_files.sh or the riscv-tests submodule change.
RISCV_TESTS ?= rv32ua-p-amoadd_w rv32ua-p-amoand_w rv32ua-p-amomaxu_w rv32ua-p-amomax_w rv32ua-p-amominu_w rv32ua-p-amomin_w rv32ua-p-amoor_w rv32ua-p-amoswap_w rv32ua-p-amoxor_w rv32ua-p-lrsc rv32ui-p-addi rv32ui-p-add rv32ui-p-andi rv32ui-p-and rv32ui-p-auipc rv32ui-p-beq rv32ui-p-bge rv32ui-p-bgeu rv32ui-p-blt rv32ui-p-bltu rv32ui-p-bne rv32ui-p-fence_i rv32ui-p-jal rv32ui-p-jalr rv32ui-p-lb rv32ui-p-lbu rv32ui-p-lh rv32ui-p-lhu rv32ui-p-lui rv32ui-p-lw rv32ui-p-ori rv32ui-p-or rv32ui-p-sb rv32ui-p-sh rv32ui-p-simple rv32ui-p-slli rv32ui-p-sll rv32ui-p-slti rv32ui-p-sltiu rv32ui-p-slt rv32ui-p-sltu rv32ui-p-srai rv32ui-p-sra rv32ui-p-srli rv32ui-p-srl rv32ui-p-sub rv32ui-p-sw rv32ui-p-xori rv32ui-p-xor rv32um-p-div rv32um-p-divu rv32um-p-mulh rv32um-p-mulhsu rv32um-p-mulhu rv32um-p-mul rv32um-p-rem rv32um-p-remu

RISCV_TEST_QEXES := $(RISCV_TESTS:%=test/%.qex)
$(RISCV_TEST_QEXES): | test
	$(ORCA_ROOT)/tools/generate_hex_files.sh

.PHONY: sw
sw: $(ORCA_TEST_QEXES) $(RISCV_TEST_QEXES)

simulate_%.tcl: simulate.tcl
	sed 's/system/system_$(*)/g' $< > $@
sim_waves_system_%.tcl: sim_waves_system.tcl
	sed 's/system/system_$(*)/g' $< > $@


test_%.log: system_%/simulation/mentor/msim_setup.tcl testall.tcl $(ORCA_HDL) $(RISCV_TEST_QEXES) $(ORCA_TEST_QEXES)
	cd system_$*/simulation/mentor && vsim -c -do "source ../../../testall.tcl; run_tests $* {$(RISCV_TESTS) $(ORCA_TESTS)}" | egrep '(^[^#]|Error:|Error \(suppressible\):)' | tee ../../../test_$*.log

.PHONY: testone
testone: $(TEST_LOG)

.PHONY: testall
testall: $(TEST_LOGS)

.PHONY: all
all: $(RISCV_TEST_QEXES) $(ORCA_TEST_QEXES) $(MSIM_FILES)

.PHONY: sim
ifndef TEST
sim:
	$(error Define TEST variable before running make sim (test/$(TEST).qex will be used))
else #ifndef TEST
test.hex::
	ln -sf test/$(TEST).qex $@

sim: $(SIM_FILE) $(SIM_WAVES_FILE) $(MSIM_FILE) test.hex test/$(TEST).qex
	cd $(SYSTEM)/simulation/mentor/; ln -sf ../../../test.hex .
	vsim -do $(SIM_FILE)
endif #else #ifndef TEST

.PHONY: clean
clean:
	rm -rf $(SYSTEMS) test test.hex $(SIM_WAVE_FILES) $(SIM_FILES) *.log
	rm -rf transcript *.sopcinfo platform.info csmith-compile *~ \#*
	rm -rf .qsys_edit

.DELETE_ON_ERROR:
